'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { Loader2, Smartphone, Mail, AlertCircle, MessageCircle } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Card } from '@/components/ui/card';
import { useToast } from '@/hooks/use-toast';
import { useAuth } from '@/hooks/use-auth';
import { sendPinAction, verifyPinAction, sendEmailPinAction, verifyEmailPinAction, sendWhatsAppPinAction, verifyWhatsAppPinAction } from '@/app/actions/auth';
import { sanitizePhone } from '@/lib/auth-utils';

const phoneSchema = z.object({
  phone: z.string().min(10, 'Phone number must be at least 10 digits').max(15, 'Phone number too long').regex(/^[\d+\s-]+$/, 'Invalid phone format'),
});

const emailSchema = z.object({
  email: z.string().email('Invalid email address'),
});

const pinSchema = z.object({
  pin: z.string().length(4, 'PIN must be 4 digits').regex(/^\d+$/, 'PIN must contain only numbers'),
});

type PhoneFormData = z.infer<typeof phoneSchema>;
type EmailFormData = z.infer<typeof emailSchema>;
type PinFormData = z.infer<typeof pinSchema>;

interface LoginFormProps {
  redirectTo?: string;
  onSuccess?: () => void;
}

export function LoginForm({ redirectTo = '/', onSuccess }: LoginFormProps) {
  const [step, setStep] = useState<'method' | 'phone' | 'email' | 'pin'>('method');
  const [authMethod, setAuthMethod] = useState<'sms' | 'email' | 'whatsapp'>('whatsapp');
  const [phone, setPhone] = useState('');
  const [email, setEmail] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [deliveryError, setDeliveryError] = useState<{ message: string; canRetryWithSMS?: boolean; canRetryWithEmail?: boolean } | null>(null);
  const [countdown, setCountdown] = useState(0);
  const router = useRouter();
  const { toast } = useToast();
  const { refreshSession } = useAuth();

  useEffect(() => {
    let timer: NodeJS.Timeout;
    if (countdown > 0) {
      timer = setInterval(() => {
        setCountdown((prev) => prev - 1);
      }, 1000);
    }
    return () => {
      if (timer) clearInterval(timer);
    };
  }, [countdown]);

  const phoneForm = useForm<PhoneFormData>({
    resolver: zodResolver(phoneSchema),
    defaultValues: {
      phone: '',
    },
  });

  const emailForm = useForm<EmailFormData>({
    resolver: zodResolver(emailSchema),
    defaultValues: {
      email: '',
    },
  });

  const pinForm = useForm<PinFormData>({
    resolver: zodResolver(pinSchema),
    defaultValues: {
      pin: '',
    },
  });

  async function handlePhoneSubmit(data: PhoneFormData) {
    setIsLoading(true);
    setSmsError(null);
    setCountdown(60);
    try {
      const result = await sendPinAction(data.phone);
      
      if (result.success) {
        // Sanitize and store phone to ensure consistency
        setPhone(sanitizePhone(data.phone));
        setAuthMethod('sms');
        setStep('pin');
        toast({
          title: 'PIN Sent',
          description: result.message,
        });
      } else {
        // Check if we can retry with email
        if (result.canRetryWithEmail) {
          // Save phone number so it's available for email fallback
          setPhone(sanitizePhone(data.phone));
          
          setSmsError({
            message: result.message,
            canRetryWithEmail: true,
          });
        } else {
          toast({
            title: 'Error',
            description: result.message,
            variant: 'destructive',
          });
        }
      }
    } catch (error) {
      toast({
        title: 'Error',
        description: 'Something went wrong. Please try again.',
        variant: 'destructive',
      });
    } finally {
      setIsLoading(false);
    }
  }

  async function handleEmailSubmit(data: EmailFormData) {
    setIsLoading(true);
    try {
      const result = await sendEmailPinAction(data.email, phone);
      
      if (result.success) {
        setEmail(data.email);
        setAuthMethod('email');
        setStep('pin');
        toast({
          title: 'PIN Sent',
          description: result.message,
        });
      } else {
        toast({
          title: 'Error',
          description: result.message,
          variant: 'destructive',
        });
      }
    } catch (error) {
      toast({
        title: 'Error',
        description: 'Something went wrong. Please try again.',
        variant: 'destructive',
      });
    } finally {
      setIsLoading(false);
    }
  }

  function handleTryEmail() {
    setSmsError(null);
    setStep('email');
  }

  async function handlePinSubmit(data: PinFormData) {
    setIsLoading(true);
    try {
      const result = authMethod === 'sms' 
        ? await verifyPinAction(phone, data.pin)
        : await verifyEmailPinAction(email, data.pin);
      
      if (result.success) {
        toast({
          title: 'Success',
          description: result.message,
        });
        
        // Refresh session to update auth state
        refreshSession();
        
        if (onSuccess) {
          onSuccess();
        } else {
          router.push(redirectTo);
          router.refresh();
        }
      } else {
        toast({
          title: 'Error',
          description: result.message,
          variant: 'destructive',
        });
      }
    } catch (error) {
      toast({
        title: 'Error',
        description: 'Something went wrong. Please try again.',
        variant: 'destructive',
      });
    } finally {
      setIsLoading(false);
    }
  }

  async function handleResendPin() {
    setCountdown(60);
    setIsLoading(true);
    try {
      const result = authMethod === 'sms'
        ? await sendPinAction(phone)
        : await sendEmailPinAction(email, phone);
      
      if (result.success) {
        toast({
          title: 'PIN Resent',
          description: authMethod === 'sms' 
            ? 'A new PIN has been sent to your phone.'
            : 'A new PIN has been sent to your email.',
        });
        pinForm.reset();
      } else {
        toast({
          title: 'Error',
          description: result.message,
          variant: 'destructive',
        });
        setCountdown(0); // Reset countdown on error so user can try again if needed
      }
    } catch (error) {
      toast({
        title: 'Error',
        description: 'Failed to resend PIN. Please try again.',
        variant: 'destructive',
      });
      setCountdown(0);
    } finally {
      setIsLoading(false);
    }
  }

  if (step === 'phone') {
    return (
      <form onSubmit={phoneForm.handleSubmit(handlePhoneSubmit)} className="space-y-4">
        {smsError && smsError.canRetryWithEmail && (
          <Alert variant="destructive" className="border-destructive/50 bg-destructive/10">
            <AlertCircle className="h-4 w-4" />
            <AlertDescription className="ml-2">
              <p className="mb-3 font-medium">{smsError.message}</p>
              <Button
                type="button"
                variant="default"
                size="sm"
                onClick={handleTryEmail}
                className="w-full"
              >
                <Mail className="mr-2 h-4 w-4" />
                Try with Email Instead
              </Button>
            </AlertDescription>
          </Alert>
        )}

        <div className="space-y-2">
          <Label htmlFor="phone">Phone Number</Label>
          <div className="relative">
            <Smartphone className="absolute left-3 top-2.5 h-5 w-5 text-muted-foreground" />
            <Input
              id="phone"
              type="tel"
              placeholder="+234 800 000 0000"
              className="pl-10"
              {...phoneForm.register('phone')}
              disabled={isLoading}
            />
          </div>
          {phoneForm.formState.errors.phone && (
            <p className="text-sm text-red-500">
              {phoneForm.formState.errors.phone.message}
            </p>
          )}
        </div>

        <Button type="submit" className="w-full" disabled={isLoading || countdown > 0}>
          {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
          {countdown > 0 ? `Wait ${countdown}s` : 'Continue'}
        </Button>

        <p className="text-center text-sm text-muted-foreground">
          We'll send a 4-digit PIN to your phone
        </p>
      </form>
    );
  }

  if (step === 'email') {
    return (
      <form onSubmit={emailForm.handleSubmit(handleEmailSubmit)} className="space-y-4">
        <Alert>
          <Mail className="h-4 w-4" />
          <AlertDescription className="ml-2">
            We'll send a verification PIN to your email address instead.
          </AlertDescription>
        </Alert>

        <div className="space-y-2">
          <Label htmlFor="email">Email Address</Label>
          <div className="relative">
            <Mail className="absolute left-3 top-2.5 h-5 w-5 text-muted-foreground" />
            <Input
              id="email"
              type="email"
              placeholder="your@email.com"
              className="pl-10"
              {...emailForm.register('email')}
              disabled={isLoading}
              autoFocus
            />
          </div>
          {emailForm.formState.errors.email && (
            <p className="text-sm text-red-500">
              {emailForm.formState.errors.email.message}
            </p>
          )}
        </div>

        <Button type="submit" className="w-full" disabled={isLoading}>
          {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
          Send PIN to Email
        </Button>

        <button
          type="button"
          onClick={() => {
            setStep('phone');
            setSmsError(null);
          }}
          className="w-full text-sm text-muted-foreground hover:text-foreground"
          disabled={isLoading}
        >
          Back to phone number
        </button>
      </form>
    );
  }

  return (
    <form onSubmit={pinForm.handleSubmit(handlePinSubmit)} className="space-y-4">
      <div className="space-y-2">
        <Label htmlFor="pin">Verification PIN</Label>
        <Input
          id="pin"
          type="text"
          inputMode="numeric"
          maxLength={4}
          placeholder="0000"
          className="text-center text-2xl tracking-widest"
          {...pinForm.register('pin')}
          disabled={isLoading}
          autoFocus
        />
        {pinForm.formState.errors.pin && (
          <p className="text-sm text-red-500">
            {pinForm.formState.errors.pin.message}
          </p>
        )}
        <p className="text-sm text-muted-foreground">
          Enter the 4-digit PIN sent to {authMethod === 'sms' ? phone : email}
        </p>
      </div>

      <Button type="submit" className="w-full" disabled={isLoading}>
        {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
        Verify & Login
      </Button>

      <div className="flex items-center justify-between text-sm">
        <button
          type="button"
          onClick={() => {
            setStep(authMethod === 'sms' ? 'phone' : 'email');
            setSmsError(null);
          }}
          className="text-muted-foreground hover:text-foreground"
          disabled={isLoading}
        >
          Change {authMethod === 'sms' ? 'phone number' : 'email'}
        </button>
        <button
          type="button"
          onClick={handleResendPin}
          className="text-primary hover:underline disabled:text-muted-foreground disabled:no-underline"
          disabled={isLoading || countdown > 0}
        >
          {countdown > 0 ? `Resend in ${countdown}s` : 'Resend PIN'}
        </button>
      </div>

      {authMethod === 'sms' && (
        <div className="mt-6">
          <Alert className="bg-amber-50 border-amber-200 shadow-sm">
            <Mail className="h-5 w-5 text-amber-600" />
            <AlertDescription className="ml-3 text-base text-amber-900">
              Having trouble receiving the SMS? You can{' '}
              <button
                type="button"
                onClick={() => {
                  setStep('email');
                  setSmsError(null);
                }}
                className="font-semibold text-amber-700 hover:text-amber-900 underline decoration-amber-700/30 underline-offset-4 hover:decoration-amber-900"
                disabled={isLoading}
              >
                verify via email
              </button>
              {' '}instead.
            </AlertDescription>
          </Alert>
        </div>
      )}
    </form>
  );
}
